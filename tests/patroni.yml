---
- hosts: patroni
  gather_facts: no
  pre_tasks:
    - raw: test -e /usr/bin/python3 || (apt-get -qq update -y && apt-get -qq install python3-minimal -y > /dev/null)
    - setup:
    - package:
        name: ['sudo', 'ca-certificates', 'locales']
    - file:
        path: /etc/udev/rules.d
        state: directory

- hosts: patroni
  roles:
    - role: ../ansible-role-patroni
      patroni_log_destination: file
      patroni_dcs_exists: true
      patroni_etcd_hosts: "etcd:2379"
      patroni_bootstrap_dcs_postgresql_pg_hba: "
        {%- set pg_hba = [dict(type='host', database='all', user='all', address='0.0.0.0/0', method='md5')] %}
        {%- for host in play_hosts %}
        {{- pg_hba.append(dict(type='host', database='replication', user=patroni_replication_username, address=hostvars[host]['ansible_host'] + '/32', method='md5')) }}
        {%- endfor %}
        {{- pg_hba -}}"
